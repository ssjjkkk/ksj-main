<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap
	PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
	"http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="lounge">
	
	<select id="selectGame" parameterClass="int" resultClass="gameVo">
		SELECT * FROM game WHERE g_no = #g_no#
	</select>
	
	<select id="selectLoungeList" parameterClass="int" resultClass="loungeVo">
		SELECT bd_no
			  ,bd_title
			  ,user_no
			  ,nick
			  ,bd_content
			  ,bd_wdt
			  ,bd_hit
			  ,NVL((SELECT SUM(like_cnt)
			  		  FROM t_like
			  		 WHERE bd_no = b.bd_no), 0) bd_like
			  ,gb_del
			  ,img_url
			  ,g_no
			  ,NVL((SELECT COUNT(*)
			  		  FROM t_board_re
			  		 WHERE bd_no = b.bd_no), 0) reply_cnt
		  FROM t_board b
		 WHERE g_no = #g_no#
		   AND gb_del = 'N'
		 ORDER BY bd_wdt DESC
	</select>
	
	<select id="selectBoardView" parameterClass="int" resultClass="loungeVo">
		SELECT *
		  FROM t_board
		 WHERE bd_no = #bd_no#
	</select>
	
	<select id="selAllLoungeList" resultClass="loungeVo">
      SELECT *
        FROM t_board
       WHERE gb_del = 'N'
       ORDER BY bd_wdt DESC
   </select>
	
	<select id="selectLoungeView" parameterClass="int" resultClass="loungeVo">
		SELECT bd_no
			  ,bd_title
			  ,user_no
			  ,nick
			  ,bd_content
			  ,bd_wdt
			  ,bd_hit
			  ,NVL((SELECT SUM(like_cnt)
			  		  FROM t_like
			  		 WHERE bd_no = b.bd_no), 0) bd_like
			  ,gb_del
			  ,img_url
			  ,g_no
			  ,NVL((SELECT COUNT(*)
			  		  FROM t_board_re
			  		 WHERE bd_no = b.bd_no), 0) reply_cnt
		  FROM t_board b
		 WHERE gb_del = 'N'
		   AND bd_no = #bd_no#
	</select>
	
	<update id="updateContent" parameterClass="loungeVo">
		UPDATE t_board
		   SET bd_title = #bd_title#,
		   	   bd_content = #bd_content#
		 WHERE bd_no = #bd_no#
	</update>
	
	<insert id="insertContent" parameterClass="loungeVo">
		
		<selectKey keyProperty="bd_no" resultClass="int">
			SELECT t_board_seq.nextval bd_no FROM dual
		</selectKey>
		
		INSERT INTO
			t_board (
						bd_no
					   ,bd_title
					   ,user_no
					   ,nick
					   ,bd_content
					   ,bd_wdt
					   ,bd_hit
					   ,bd_like
					   ,gb_del
					   ,img_url
					   ,g_no
					   ,reply_cnt
					)
			VALUES (
						#bd_no#
					   ,#bd_title#
					   ,#user_no#
					   ,#nick#
					   ,#bd_content#
					   ,sysdate
					   ,0
					   ,0
					   ,'N'
					   ,null
					   ,#g_no#
					   ,0
					)
	
	</insert>
	
	<insert id="insertReply" parameterClass="replyVo">
      
      <selectKey keyProperty="re_no" resultClass="int">
         SELECT re_seq.nextval re_no FROM dual
      </selectKey>
      
      INSERT INTO
         t_board_re (re_no, bd_no, user_no, nick, re_content, re_wdt, gb_del)
         VALUES (#re_no#, #bd_no#, #user_no#, #nick#, #re_content#, SYSDATE, 'N')
   </insert>
   
   <select id="selectReply" parameterClass="int" resultClass="replyVo">
      SELECT re_no
            ,bd_no
            ,user_no
            ,nick
            ,re_content
            ,re_wdt
        FROM t_board_re
       WHERE re_no = #re_no#
         AND gb_del = 'N'
   </select>
   
   <select id="selectReplyList" parameterClass="int" resultClass="replyVo">
      SELECT re_no
            ,bd_no
            ,user_no
            ,nick
            ,re_content
            ,re_wdt
        FROM t_board_re
       WHERE bd_no = #bd_no#
         AND gb_del = 'N'
       ORDER BY re_no DESC
   </select>
   
	<update id="increaseHit" parameterClass="int">
		UPDATE t_board
		   SET bd_hit = bd_hit + 1
		 WHERE bd_no = #bd_no#
	</update>
   
	<update id="updateLike" parameterClass="likeVo">
		MERGE INTO t_like l
		USING dual
		   ON (l.bd_no = #bd_no# AND l.user_no = #user_no#)
		 WHEN MATCHED THEN
		 	UPDATE SET l.like_cnt = (l.like_cnt + #like_cnt#)
		 WHEN NOT MATCHED THEN
		 	INSERT (l.bd_no, l.user_no, l.like_cnt)
		 	VALUES (#bd_no#, #user_no#, #like_cnt#)
	</update>
	
	<select id="selectLikeCount" parameterClass="int" resultClass="int">
		SELECT NVL(SUM(like_cnt), 0) 
		  FROM t_like
		 WHERE bd_no = #bd_no#
	</select>
	
	<select id="selectUserLike" parameterClass="likeVo" resultClass="int">
		SELECT like_cnt 
		  FROM t_like
		 WHERE bd_no = #bd_no#
		   AND user_no = #user_no#
	</select>
         
	<insert id="joinLounge" parameterClass="gVo">
		INSERT INTO
         g_user (user_no, g_no)
         VALUES (#user_no#, #g_no#)
	</insert> 
	
	<select id="selGUser" parameterClass="gVo" resultClass="int">
		SELECT nvl(max(USER_NO), 0) user_no
		  FROM g_user
		 WHERE user_no = #user_no#
		   AND g_no = #g_no# 
	</select>
	
	<delete id="delGUser" parameterClass="gVo">
		DELETE FROM g_user
		 WHERE user_no = #user_no#
		   AND g_no = #g_no#
	</delete> 
	
	<update id="increaseGU" parameterClass="gVo">
		UPDATE game
		   SET g_user = g_user + 1
		 WHERE g_no = #g_no#
	</update>
	
	<update id="delGU" parameterClass="gVo">
		UPDATE game
		   SET g_user = g_user - 1
		 WHERE g_no = #g_no#
	</update>
	
	<update id="increaseDown" parameterClass="int">
		UPDATE game
		   SET g_like = g_like + 1
		 WHERE g_no = #N#
	</update>
	
	
	<select id="selectSLoungeList" parameterClass="Map" resultClass="loungeVo">
			SELECT bd_no
				  ,bd_title
				  ,user_no
				  ,nick
				  ,bd_content
				  ,bd_wdt
				  ,bd_hit
				  ,NVL((SELECT SUM(like_cnt)
				  		  FROM t_like
				  		 WHERE bd_no = b.bd_no), 0) bd_like
				  ,gb_del
				  ,img_url
				  ,g_no
				  ,NVL((SELECT COUNT(*)
				  		  FROM t_board_re
				  		 WHERE bd_no = b.bd_no), 0) reply_cnt
			  FROM t_board b
			 WHERE g_no = #g_no#
			   AND gb_del = 'N'
			   AND bd_title LIKE '%'||#search#||'%'
			 ORDER BY bd_wdt DESC
   </select>
   
   <select id="memGameList" parameterClass="int" resultClass="GameVo">
      SELECT *
         FROM g_user u, game g
       WHERE u.g_no = g.g_no
         AND u.user_no = #user_no#
   </select>
	
</sqlMap>